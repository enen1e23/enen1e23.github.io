<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>è¥¿å®‰å¸‚å¤æ ‘åæœ¨äº’åŠ¨åœ°å›¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- å¼•å…¥ Leaflet æ ·å¼ -->
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Microsoft YaHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f6f4f1;
    }
    .layout {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 340px;
      max-width: 100%;
      box-sizing: border-box;
      padding: 16px 18px;
      background: #f9f6f1;
      border-right: 1px solid #e0d6c8;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    .sidebar h1 {
      font-size: 20px;
      margin: 0 0 6px;
      font-weight: 600;
      color: #5a3d32;
    }
    .sidebar h2 {
      font-size: 14px;
      margin: 12px 0 4px;
      font-weight: 600;
      color: #5a3d32;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sidebar p {
      margin: 0;
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      background: #e7d6c6;
      color: #5a3d32;
      margin-right: 4px;
    }
    #map {
      flex: 1;
      height: 100vh;
    }

    input[type="text"],
    input[type="range"],
    select {
      font-family: inherit;
    }

    #searchBox {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d0c4b3;
      font-size: 12px;
      box-sizing: border-box;
      outline: none;
    }
    #searchBox:focus {
      border-color: #7aa28f;
      box-shadow: 0 0 0 1px rgba(122,162,143,0.25);
    }

    .small-text {
      font-size: 11px;
      color: #777;
    }

    /* æ—¶é—´è½´æŒ‰é’® */
    #timeline {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .timeline-btn {
      padding: 3px 8px;
      background: #eee3da;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid transparent;
      user-select: none;
    }
    .timeline-btn:hover {
      background: #e0d0c2;
    }
    .timeline-btn.active {
      background: #7aa28f;
      color: #fff;
      border-color: #5d8572;
    }

    /* ç»Ÿè®¡å›¾å®¹å™¨ */
    .chart-card {
      background: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid #e5ddd2;
    }

    .legend {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: #a18c7a;
    }

    /* Leaflet infoWindow é»˜è®¤å­—ä½“å˜å°ä¸€ç‚¹ */
    .leaflet-popup-content {
      font-size: 12px;
      line-height: 1.5;
    }
    .leaflet-popup-content b {
      font-size: 13px;
    }

    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 50vh;
        border-right: none;
        border-bottom: 1px solid #e0d6c8;
      }
      #map {
        height: 50vh;
      }
    }

    /* å›¾è¡¨çš„å®¹å™¨å°ºå¯¸ */
    #speciesChart {
      height: 120px; /* è°ƒæ•´å›¾è¡¨é«˜åº¦ */
      width: 250px;   /* è°ƒæ•´å›¾è¡¨å®½åº¦ */
    }
  </style>

  <!-- å¼•å…¥ Leaflet JS -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin=""
  ></script>

  <!-- å¼•å…¥ Chart.jsï¼Œç”¨äºæ ‘ç§ç»Ÿè®¡å›¾ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- å¤æ ‘æ•°æ®ï¼švar XA_GUSHU = [...] -->
  <script src="xa_gushu.js"></script>
</head>
<body>
<div class="layout">
  <!-- ===== å·¦ä¾§æ§åˆ¶æ  ===== -->
  <aside class="sidebar">
    <div>
      <h1>è¥¿å®‰å¸‚å¤æ ‘åæœ¨</h1>
      <p class="small-text">
        æ•°æ®æ¥æºï¼šè¥¿å®‰å¸‚åŸå¸‚å¤æ ‘åæœ¨æ¸…å•ï¼ˆåæ ‡ç³»ï¼šWGS84ï¼Œå¯¹æ¥ OpenStreetMapï¼‰ã€‚<br/>
      </p>
      <div style="margin-top:4px;">
        <span class="tag">å¸‚æ ‘ï¼šå›½æ§</span>
        <span class="tag" id="treeCountTag">å…± 0 æ ª</span>
      </div>
    </div>

    <!-- æœç´¢ -->
    <div>
      <h2>ğŸ” æœç´¢å¤æ ‘</h2>
      <input
        id="searchBox"
        type="text"
        placeholder="æŒ‰æ ‘ç§ã€ä½ç½®ã€ç®¡æŠ¤å•ä½ç­‰å…³é”®å­—æœç´¢ï¼Œå¦‚ï¼šå›½æ§ / å¤§æ…ˆæ©å¯º / è²æ¹–"
      />
      <p class="small-text" style="margin-top:4px;">
        æ”¯æŒæ¨¡ç³Šæœç´¢ï¼šæ ‘ç§å + ç®¡æŠ¤å•ä½ + åœ°å€ + ä¿—åã€‚
      </p>
    </div>

    <!-- æ ‘é¾„ç­›é€‰ -->
    <div>
      <h2>ğŸŒ± æŒ‰æ ‘é¾„ç­›é€‰</h2>
      <div class="small-text" style="margin-bottom:4px;">
        å½“å‰èŒƒå›´ï¼š<span id="ageMinLabel">0</span> å¹´ ï½ <span id="ageMaxLabel">1000</span> å¹´
      </div>
      <input type="range" id="ageMin" min="0" max="1000" value="0" />
      <input type="range" id="ageMax" min="0" max="1000" value="1000" style="margin-top:4px;" />
      <p class="small-text" style="margin-top:4px;">
        å°‘æ•°è®°å½•ä¸ºâ€œ300â€“499 å¹´â€â€œ500å¹´ä»¥ä¸Šâ€ï¼Œå·²è½¬æ¢ä¸ºè¿‘ä¼¼æ•°å€¼å‚ä¸ç­›é€‰ã€‚
      </p>
    </div>

    <!-- æ—¶é—´è½´ -->
    <div>
      <h2>â³ å¹´ä»£æ—¶é—´è½´</h2>
      <div id="timeline">
        <div class="timeline-btn" data-range="0-200">0â€“200 å¹´</div>
        <div class="timeline-btn" data-range="200-300">200â€“300 å¹´</div>
        <div class="timeline-btn" data-range="300-500">300â€“500 å¹´</div>
        <div class="timeline-btn" data-range="500-9999">500 å¹´ä»¥ä¸Š</div>
        <div class="timeline-btn" data-range="0-9999">å…¨éƒ¨</div>
      </div>
    </div>

    <!-- æ ‘ç§ç»Ÿè®¡å›¾ -->
    <div>
      <h2>ğŸ“Š æ ‘ç§ç»„æˆ</h2>
      <div class="chart-card">
        <canvas id="speciesChart" height="120" width="250"></canvas> <!-- è®¾ç½®å›¾è¡¨é«˜åº¦ä¸º120pxï¼Œå®½åº¦ä¸º250px -->
        <div class="legend">
          ç»Ÿè®¡çš„æ˜¯å¤æ ‘æ•°é‡å‰è‹¥å¹²çš„æ ‘ç§ï¼Œå…¶ä½™åˆå¹¶ä¸ºâ€œå…¶å®ƒæ ‘ç§â€ã€‚é¢œè‰²ä½¿ç”¨ä¸€ç»„æŸ”å’Œçš„è«å…°è¿ªè‰²ã€‚
        </div>
      </div>
    </div>

    <div class="footer-note">
      ğŸ’¡ å°è´´å£«ï¼šæ”¯æŒç¼©æ”¾ã€æ‹–åŠ¨åœ°å›¾ï¼›ç‚¹å‡»åœ†ç‚¹å¯æŸ¥çœ‹æ¯ä¸€æ ªå¤æ ‘è¯¦æƒ…ã€‚
    </div>
  </aside>

  <!-- ===== å³ä¾§åœ°å›¾ ===== -->
  <main id="map"></main>
</div>

<script>
  // ===================== å·¥å…·å‡½æ•°ï¼šè§£ææ ‘é¾„å­—ç¬¦ä¸² =====================
  function parseAgeToNumber(ageStr) {
    if (!ageStr) return NaN;
    const s = String(ageStr).trim();

    // çº¯æ•°å­—
    if (/^\d+$/.test(s)) return parseInt(s, 10);

    // å«â€œå¹´ä»¥ä¸Šâ€
    const m1 = s.match(/(\d+)\s*å¹´ä»¥ä¸Š/);
    if (m1) return parseInt(m1[1], 10);

    // â€œ300-499å¹´â€ å–åŒºé—´ä¸­å€¼
    const m2 = s.match(/(\d+)\s*[-~ï½]\s*(\d+)/);
    if (m2) {
      const a = parseInt(m2[1], 10);
      const b = parseInt(m2[2], 10);
      return Math.round((a + b) / 2);
    }

    // ç»“å°¾æœ‰â€œå¹´â€
    const m3 = s.match(/(\d+)\s*å¹´/);
    if (m3) return parseInt(m3[1], 10);

    return NaN;
  }

  // ===================== Leaflet åˆå§‹åŒ– =====================
  const map = L.map("map").setView([34.27, 108.95], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap è´¡çŒ®è€…'
  }).addTo(map);

  // ===================== æ¸²æŸ“å¤æ ‘ç‚¹ =====================
  const allMarkers = [];
  const speciesCount = {};
  let globalMinAge = Infinity;
  let globalMaxAge = -Infinity;

  function levelColor(level) {
    if (!level) return "#7aa28f";
    if (level.indexOf("ä¸€") !== -1) return "#b6543f"; // ä¸€çº§
    if (level.indexOf("äºŒ") !== -1) return "#c7796b"; // äºŒçº§
    return "#8ca66b";                                // ä¸‰çº§/å…¶å®ƒ
  }

  if (typeof XA_GUSHU === "undefined") {
    alert("æœªæ‰¾åˆ° XA_GUSHUï¼Œè¯·æ£€æŸ¥ xa_gushu.js æ˜¯å¦åœ¨åŒä¸€ç›®å½•ã€‚");
  } else {
    XA_GUSHU.forEach(tree => {
      const lng = parseFloat(tree.lng);
      const lat = parseFloat(tree.lat);
      if (!isFinite(lng) || !isFinite(lat)) return;

      const ageNum = parseAgeToNumber(tree.age);
      if (isFinite(ageNum)) {
        globalMinAge = Math.min(globalMinAge, ageNum);
        globalMaxAge = Math.max(globalMaxAge, ageNum);
      }

      const pos = [lat, lng];
      const color = levelColor(tree.level);

      const marker = L.circleMarker(pos, {
        radius: 4,
        color: "#ffffff",
        weight: 0.8,
        fillColor: color,
        fillOpacity: 0.9
      }).addTo(map);

      // ä¿å­˜åŸå§‹æ•°æ®åˆ° marker
      marker._treeData = {
        ...tree,
        ageNum
      };

      const popupHtml = `
        <div>
          <b>${tree.name || ""} ${tree.alias ? "ï¼ˆ" + tree.alias + "ï¼‰" : ""}</b><br/>
          å¤æ ‘ç¼–å·ï¼š${tree.id || ""}<br/>
          æ ‘é¾„ï¼š${tree.age || ""}<br/>
          ç­‰çº§ï¼š${tree.level || ""}<br/>
          ä½ç½®ï¼š${tree.address || ""}<br/>
          ç®¡æŠ¤å•ä½ï¼š${tree.manager || ""}<br/>
          ç®¡æŠ¤è´£ä»»äººï¼š${tree.manager_person || ""}<br/>
          æ–‡ç‰©ä¿æŠ¤å•ä½å†…ï¼š${tree.in_heritage || ""}
        </div>
      `;
      marker.bindPopup(popupHtml);

      allMarkers.push(marker);

      // ç»Ÿè®¡æ ‘ç§
      const sp = tree.name || "æœªæ³¨æ˜";
      speciesCount[sp] = (speciesCount[sp] || 0) + 1;
    });

    if (allMarkers.length > 0) {
      map.fitBounds(L.featureGroup(allMarkers).getBounds(), {
        padding: [40, 40]
      });
    }

    // æ˜¾ç¤ºæ€»æ•°
    const tag = document.getElementById("treeCountTag");
    if (tag) tag.textContent = `å…± ${allMarkers.length} æ ª`;
  }

  // ===================== åˆå§‹åŒ–æ ‘é¾„æ»‘å— =====================
  const ageMinSlider = document.getElementById("ageMin");
  const ageMaxSlider = document.getElementById("ageMax");
  const ageMinLabel  = document.getElementById("ageMinLabel");
  const ageMaxLabel  = document.getElementById("ageMaxLabel");

  if (!isFinite(globalMinAge)) { globalMinAge = 0; }
  if (!isFinite(globalMaxAge)) { globalMaxAge = 1000; }

  // ç»™ä¸€ç‚¹å†—ä½™
  const sliderMin = Math.max(0, Math.floor(globalMinAge / 50) * 50);
  const sliderMax = Math.ceil(globalMaxAge / 50) * 50;

  ageMinSlider.min = sliderMin;
  ageMinSlider.max = sliderMax;
  ageMaxSlider.min = sliderMin;
  ageMaxSlider.max = sliderMax;

  ageMinSlider.value = sliderMin;
  ageMaxSlider.value = sliderMax;

  ageMinLabel.textContent = sliderMin;
  ageMaxLabel.textContent = sliderMax;

  let currentSearchKW = "";
  let currentAgeMin = sliderMin;
  let currentAgeMax = sliderMax;

  // ===================== ç»Ÿä¸€è¿‡æ»¤å‡½æ•°ï¼ˆæœç´¢ + æ ‘é¾„ + æ—¶é—´è½´ï¼‰ =====================
  function applyFilters() {
    const kw = currentSearchKW.trim().toLowerCase();

    allMarkers.forEach(marker => {
      const t = marker._treeData;
      const age = t.ageNum;
      let visible = true;

      // æœç´¢åŒ¹é…
      if (kw) {
        const text = (t.name + " " + (t.alias || "") + " " +
                      (t.address || "") + " " +
                      (t.manager || "")).toLowerCase();
        if (!text.includes(kw)) visible = false;
      }

      // æ ‘é¾„èŒƒå›´
      if (visible && isFinite(age)) {
        if (age < currentAgeMin || age > currentAgeMax) visible = false;
      }
      // æ²¡æœ‰å¹´é¾„æ•°æ®çš„ï¼Œå¦‚æœå¼€å¯äº†èŒƒå›´ç­›é€‰ï¼Œåˆ™å¼±åŒ–æ˜¾ç¤º
      if (visible && !isFinite(age) &&
          (currentAgeMin > sliderMin || currentAgeMax < sliderMax)) {
        visible = false;
      }

      if (visible) {
        marker.setStyle({
          fillOpacity: 0.9,
          opacity: 1,
          radius: 4
        });
      } else {
        marker.setStyle({
          fillOpacity: 0.05,
          opacity: 0.1,
          radius: 3
        });
      }
    });
  }

  // ===================== æœç´¢æ¡†äº‹ä»¶ =====================
  const searchBox = document.getElementById("searchBox");
  searchBox.addEventListener("input", function () {
    currentSearchKW = this.value;
    applyFilters();
  });

  // ===================== æ ‘é¾„æ»‘å—äº‹ä»¶ =====================
  function onAgeSliderChange() {
    let vMin = parseInt(ageMinSlider.value, 10);
    let vMax = parseInt(ageMaxSlider.value, 10);

    // ä¿è¯æœ€å°å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
    if (vMin > vMax) {
      const tmp = vMin;
      vMin = vMax;
      vMax = tmp;
    }

    currentAgeMin = vMin;
    currentAgeMax = vMax;
    ageMinLabel.textContent = vMin;
    ageMaxLabel.textContent = vMax;

    // å–æ¶ˆæ—¶é—´è½´çš„é«˜äº®
    document.querySelectorAll(".timeline-btn").forEach(btn => {
      if (btn.dataset.range !== "0-9999") btn.classList.remove("active");
    });

    applyFilters();
  }

  ageMinSlider.addEventListener("input", onAgeSliderChange);
  ageMaxSlider.addEventListener("input", onAgeSliderChange);

  // ===================== æ—¶é—´è½´æŒ‰é’®äº‹ä»¶ =====================
  document.querySelectorAll(".timeline-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      // æŒ‰é’®é«˜äº®
      document.querySelectorAll(".timeline-btn").forEach(b => b.classList.remove("active"));
      this.classList.add("active");

      const [minStr, maxStr] = this.dataset.range.split("-");
      const minAge = parseInt(minStr, 10);
      const maxAge = parseInt(maxStr, 10);

      currentAgeMin = minAge;
      currentAgeMax = maxAge;

      // åŒ

