<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>西安市古树名木地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet 样式 -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .app-container {
      display: flex;
      height: 100%;
      width: 100%;
    }

    /* 左侧信息栏 */
    .sidebar {
      width: 320px;
      max-width: 360px;
      background: #ffffff;
      border-right: 1px solid #e0e0e0;
      padding: 14px 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 2px 0 6px rgba(0, 0, 0, 0.04);
    }

    .sidebar h1 {
      font-size: 18px;
      margin: 0 0 4px;
      color: #333;
    }
    .sidebar h2 {
      font-size: 14px;
      margin: 8px 0 4px;
      color: #555;
    }
    .sidebar p {
      font-size: 12px;
      margin: 0;
      color: #666;
      line-height: 1.6;
    }

    .summary-box {
      background: #fafafa;
      border-radius: 6px;
      padding: 8px 10px;
      border: 1px solid #eee;
      font-size: 12px;
      color: #555;
    }

    /* 树种统计列表 */
    .species-list {
      margin: 4px 0 0;
      padding: 0;
      list-style: none;
      max-height: 45vh;
      overflow-y: auto;
      border-radius: 4px;
      border: 1px solid #f0f0f0;
      background: #fcfcfc;
    }

    .species-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .species-item:nth-child(odd) {
      background: #fafafa;
    }

    .species-item:hover {
      background: #e8f3ff;
    }

    .species-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      flex-shrink: 0;
    }

    .species-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .species-count {
      margin-left: 6px;
      color: #999;
      font-size: 11px;
    }

    .species-bar {
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, #b1c5a4, #7aa28f);
      margin-left: 6px;
      flex-shrink: 0;
    }

    .legend-box {
      margin-top: 4px;
      font-size: 12px;
    }
    .legend-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .hint {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
      line-height: 1.5;
    }

    /* 地图区域 */
    #map {
      flex: 1;
      height: 100%;
    }

    /* 信息弹窗 */
    .info-window {
      font-size: 12px;
      line-height: 1.6;
    }
    .info-window b {
      font-size: 14px;
    }
  </style>

  <!-- Leaflet 脚本 -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- 古树数据（高德地理编码结果，GCJ-02） -->
  <script src="xa_gushu.js"></script>
</head>
<body>
<div class="app-container">
  <div class="sidebar">
    <h1>西安市古树名木地图</h1>
    <p>基于西安市古树名木清单（地理编码自“位置”字段），底图使用 OpenStreetMap。</p>

    <div class="summary-box" id="summary-box">
      载入数据中…
    </div>

    <h2>按树种统计（中文名）</h2>
    <ul class="species-list" id="species-list"></ul>

    <div class="legend-box">
      <h2>图例 · 等级</h2>
      <div class="legend-row">
        <div class="legend-dot" style="background:#d73027;"></div> 一级古树
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="background:#fc8d59;"></div> 二级古树
      </div>
      <div class="legend-row">
        <div class="legend-dot" style="background:#91cf60;"></div> 三级古树
      </div>
    </div>

    <p class="hint">
      点击树种名称，可在地图中高亮该树种的古树点。再次点击可取消过滤，恢复全部显示。
    </p>
  </div>

  <div id="map"></div>
</div>

<script>
  // ============ GCJ-02 → WGS84 转换（JS 版） ============
  const PI = Math.PI;
  const a = 6378245.0;
  const ee = 0.006693421622965943;

  function outOfChina(lng, lat) {
    return !(lng > 73.66 && lng < 135.05 && lat > 3.86 && lat < 53.55);
  }

  function transformLat(lng, lat) {
    let ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat
            + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
    ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
    ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
    return ret;
  }

  function transformLng(lng, lat) {
    let ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng
            + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
    ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
    ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
    return ret;
  }

  // 输入：高德 GCJ-02 坐标 → 输出：WGS84
  function gcj02ToWgs84(lng, lat) {
    lng = Number(lng);
    lat = Number(lat);
    if (outOfChina(lng, lat)) {
      return [lng, lat];
    }
    let dlat = transformLat(lng - 105.0, lat - 35.0);
    let dlng = transformLng(lng - 105.0, lat - 35.0);
    const radlat = lat / 180.0 * PI;
    let magic = Math.sin(radlat);
    magic = 1 - ee * magic * magic;
    const sqrtMagic = Math.sqrt(magic);
    dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
    dlng = (dlng * 180.0) / (a / sqrtMagic * Math.cos(radlat) * PI);
    const mgLat = lat + dlat;
    const mgLng = lng + dlng;
    return [lng - dlng, lat - dlat];
  }

  // ============ 地图初始化（Leaflet + OSM） ============
  const map = L.map('map').setView([34.27, 108.95], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> 贡献者 | 坐标：GCJ-02 → WGS84 近似转换'
  }).addTo(map);

  // 等级 → 颜色
  function levelColor(level) {
    if (!level) return "#3388ff";
    if (String(level).indexOf("一") !== -1) return "#d73027"; // 一级
    if (String(level).indexOf("二") !== -1) return "#fc8d59"; // 二级
    return "#91cf60";                                       // 三级/其它
  }

  const allMarkers = [];
  const speciesStats = {};      // { 中文名: { count, markers: [] } }
  let currentFilter = null;     // 当前被高亮的树种

  // 信息窗（用 Leaflet Popup）
  function makePopupHtml(t) {
    return `
      <div class="info-window">
        <b>${t.name || ""}${t.alias ? "（" + t.alias + "）" : ""}</b><br/>
        古树编号：${t.id || ""}<br/>
        树龄：${t.age || ""}<br/>
        等级：${t.level || ""}<br/>
        位置：${t.address || ""}<br/>
        管护单位：${t.manager || ""}<br/>
        管护责任人：${t.manager_person || ""}<br/>
        文保单位内：${t.in_heritage || ""}
      </div>
    `;
  }

  // 统计总数 & 创建点
  (function initMapAndStats() {
    if (typeof XA_GUSHU === "undefined") {
      alert("未找到 XA_GUSHU 数据，请确认 xa_gushu.js 与本文件在同一文件夹。");
      return;
    }

    let validCount = 0;
    XA_GUSHU.forEach(function (t) {
      if (t.lng == null || t.lat == null || t.lng === "" || t.lat === "") return;

      // 1. 把高德 GCJ-02 转成 WGS84
      const [lngWgs, latWgs] = gcj02ToWgs84(t.lng, t.lat);
      if (isNaN(lngWgs) || isNaN(latWgs)) return;

      const color = levelColor(t.level);

      const marker = L.circleMarker([latWgs, lngWgs], {
        radius: 4,
        color: "#ffffff",
        weight: 1,
        fillColor: color,
        fillOpacity: 0.9
      }).addTo(map);

      marker.bindPopup(makePopupHtml(t));
      marker._treeData = t;   // 附加数据，方便后面过滤使用

      allMarkers.push(marker);
      validCount += 1;

      // 2. 统计树种（按中文名）
      const sp = t.name || "未命名树种";
      if (!speciesStats[sp]) {
        speciesStats[sp] = { count: 0, markers: [] };
      }
      speciesStats[sp].count += 1;
      speciesStats[sp].markers.push(marker);
    });

    // 自动缩放到所有点
    if (allMarkers.length > 0) {
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds().pad(0.1));
    }

    // 更新左侧 summary
    const summaryBox = document.getElementById("summary-box");
    const speciesCount = Object.keys(speciesStats).length;
    summaryBox.innerHTML = `
      共定位到 <b>${validCount}</b> 棵古树，分属 <b>${speciesCount}</b> 个树种。<br/>
      数据字段来自：古树编号、中文名、俗名、位置、树龄、等级、管护单位等。
    `;

    // 绘制树种统计列表
    renderSpeciesList();
  })();

  // ============ 左侧树种列表 & 交互 ============
  function renderSpeciesList() {
    const listEl = document.getElementById("species-list");
    listEl.innerHTML = "";

    // 转数组并按数量排序
    const items = Object.keys(speciesStats).map(function (name) {
      return {
        name: name,
        count: speciesStats[name].count,
        markers: speciesStats[name].markers
      };
    }).sort(function (a, b) {
      return b.count - a.count;
    });

    if (items.length === 0) {
      listEl.innerHTML = "<li style='padding:6px 8px;font-size:12px;color:#999;'>暂无树种统计。</li>";
      return;
    }

    // 计算最大值，用于条形宽度
    const maxCount = items[0].count;

    items.forEach(function (item, index) {
      const li = document.createElement("li");
      li.className = "species-item";
      li.dataset.species = item.name;

      const colorDot = document.createElement("div");
      colorDot.className = "species-color";
      // 简单用一个柔和的绿色系，避免太花
      colorDot.style.background = "#7aa28f";

      const nameSpan = document.createElement("span");
      nameSpan.className = "species-name";
      nameSpan.textContent = item.name;

      const countSpan = document.createElement("span");
      countSpan.className = "species-count";
      countSpan.textContent = item.count;

      const bar = document.createElement("div");
      bar.className = "species-bar";
      const ratio = item.count / maxCount;
      bar.style.width = (40 + ratio * 60) + "px";  // 最短 40px，最长 ~100px

      li.appendChild(colorDot);
      li.appendChild(nameSpan);
      li.appendChild(countSpan);
      li.appendChild(bar);

      // 点击过滤/高亮
      li.addEventListener("click", function () {
        const sp = li.dataset.species;
        toggleSpeciesFilter(sp, li);
      });

      listEl.appendChild(li);
    });
  }

  // 切换某个树种的过滤 / 高亮
  function toggleSpeciesFilter(speciesName, liElement) {
    const isSame = (currentFilter === speciesName);

    // 如果点击的是当前已选树种 → 取消过滤，恢复全部
    if (isSame) {
      currentFilter = null;
      // 恢复所有点样式
      allMarkers.forEach(function (m) {
        const t = m._treeData || {};
        const color = levelColor(t.level);
        m.setStyle({
          radius: 4,
          fillColor: color,
          fillOpacity: 0.9,
          opacity: 1
        });
      });
      // 恢复所有列表项样式
      const allItems = document.querySelectorAll(".species-item");
      allItems.forEach(function (el) {
        el.style.backgroundColor = "";
        el.style.fontWeight = "normal";
      });
      return;
    }

    currentFilter = speciesName;

    // 先统一降暗所有点
    allMarkers.forEach(function (m) {
      m.setStyle({
        fillOpacity: 0.15,
        opacity: 0.3,
        radius: 3
      });
    });

    // 高亮指定树种
    const target = speciesStats[speciesName];
    if (target) {
      target.markers.forEach(function (m) {
        const t = m._treeData || {};
        const color = levelColor(t.level);
        m.setStyle({
          fillOpacity: 0.95,
          opacity: 1,
          radius: 5,
          fillColor: color
        });
      });

      // 地图缩放到该树种范围
      const group = L.featureGroup(target.markers);
      map.fitBounds(group.getBounds().pad(0.1));
    }

    // 更新左侧列表高亮效果
    const allItems = document.querySelectorAll(".species-item");
    allItems.forEach(function (el) {
      if (el.dataset.species === speciesName) {
        el.style.backgroundColor = "#e0f0ff";
        el.style.fontWeight = "bold";
      } else {
        el.style.backgroundColor = "";
        el.style.fontWeight = "normal";
      }
    });
  }
</script>
</body>
</html>

