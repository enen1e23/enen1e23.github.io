<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>西安市古树名木互动地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Microsoft YaHei", "SimHei", system-ui, sans-serif;
      background-color: #f7f7f5;
    }

    #app {
      display: flex;
      flex-direction: row;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1 1 auto;
      height: 100%;
    }

    #sidebar {
      width: 360px;
      max-width: 100%;
      background-color: #fcfbf8;
      border-left: 1px solid #e0ddd5;
      box-shadow: -3px 0 8px rgba(0, 0, 0, 0.06);
      padding: 16px 18px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h1 {
      font-size: 20px;
      margin: 0 0 6px 0;
    }

    #sidebar .subtitle {
      font-size: 12px;
      color: #777;
      margin-bottom: 10px;
    }

    #sidebar .section-title {
      font-size: 14px;
      margin-top: 14px;
      margin-bottom: 6px;
      font-weight: bold;
    }

    #sidebar p {
      font-size: 12px;
      margin: 3px 0;
      line-height: 1.6;
    }

    .legend {
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      border: 1px solid #eee;
    }

    #chart-container {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background-color: #f4f2ec;
      border: 1px solid #e4dfd4;
    }

    #speciesChart {
      width: 100%;
      height: 260px;
    }

    .note {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }

    /* 信息框样式 */
    .info-window {
      font-size: 12px;
      line-height: 1.6;
    }
    .info-window b {
      font-size: 14px;
    }

    @media (max-width: 768px) {
      #app {
        flex-direction: column;
      }
      #map {
        height: 50%;
      }
      #sidebar {
        width: 100%;
        height: 50%;
        border-left: none;
        border-top: 1px solid #e0ddd5;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <h1>西安市古树名木地图</h1>
    <div class="subtitle">市树是国槐，果然是分布最多的古树。</div>

    <div class="section-title">图例（按古树等级）</div>
    <div class="legend">
      <div class="legend-item">
        <span class="legend-color" style="background:#C26161;"></span>
        一级古树
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#D9CC66;"></span>
        二级古树
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#79C26D;"></span>
        三级古树
      </div>
    </div>

    <div class="section-title">树种组成（前 10 类 + 其他）</div>
    <div id="chart-container">
      <canvas id="speciesChart"></canvas>
      <div class="note">
        数据来源：西安市城市古树名木清单。统计口径与 Python 版本图一致：
        取前 10 个树种单列，其余合并为“其他树种”。
      </div>
    </div>

    <div class="section-title">使用说明</div>
    <p>① 在地图上缩放、拖动，查看各区古树分布。</p>
    <p>② 点击圆点，可查看古树编号、树龄、等级、具体位置等信息。</p>
    <p>③ 右侧统计图展示树种占比结构，可直观看到“谁最多”。</p>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<!-- Chart.js，用来画树种组成图 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 古树点数据：由 Python 生成的 XA_GUSHU -->
<script src="xa_gushu.js"></script>

<script>
  console.log("JS 正常运行");

  // 1. 初始化地图（OpenStreetMap 底图）
  var map = L.map('map').setView([34.27, 108.95], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> 贡献者'
  }).addTo(map);

  // 2. 颜色映射：沿用 Morandi 系列
  function levelColor(level) {
    if (!level) return "#5C3D4C";      // 默认深紫红
    if (level.indexOf("一") !== -1) return "#C26161"; // 一级：暖红
    if (level.indexOf("二") !== -1) return "#D9CC66"; // 二级：土黄
    return "#79C26D";                                  // 三级及其他：浅绿
  }

  // 3. 地图上画古树点，并收集所有坐标
  var markerLayer = L.layerGroup().addTo(map);
  var allLatLngs = [];

  if (typeof XA_GUSHU === "undefined") {
    alert("未找到 XA_GUSHU 数据，请确认 xa_gushu.js 与本文件在同一文件夹。");
  } else {
    XA_GUSHU.forEach(function(t) {
      if (!t.lng || !t.lat) return;

      var lat = Number(t.lat);
      var lng = Number(t.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      var color = levelColor(String(t.level || ""));

      var marker = L.circleMarker([lat, lng], {
        radius: 5,
        color: "#ffffff",
        weight: 1,
        fillColor: color,
        fillOpacity: 0.9
      }).addTo(markerLayer);

      var popupHtml = `
        <div class="info-window">
          <b>${t.name || ""}${t.alias ? "（" + t.alias + "）" : ""}</b><br/>
          古树编号：${t.id || ""}<br/>
          树龄：${t.age || ""}<br/>
          等级：${t.level || ""}<br/>
          位置：${t.address || ""}<br/>
          管护单位：${t.manager || ""}<br/>
          管护责任人：${t.manager_person || ""}<br/>
          文保单位内：${t.in_heritage || ""}
        </div>
      `;
      marker.bindPopup(popupHtml);

      allLatLngs.push([lat, lng]);
    });

    if (allLatLngs.length > 0) {
      var bounds = L.latLngBounds(allLatLngs);
      map.fitBounds(bounds.pad(0.1));
    }
  }

  // 4. 树种组成统计（逻辑与 Python 版本一致：前 10 + “其他树种”）
  function buildSpeciesStats(trees, topN) {
    var counts = {};  // {树种: 数量}

    trees.forEach(function(t) {
      var name = (t.name || "").trim();
      if (!name) return;
      if (!counts[name]) counts[name] = 0;
      counts[name] += 1;
    });

    var entries = Object.keys(counts).map(function(name) {
      return { name: name, count: counts[name] };
    });

    // 按数量从大到小排序
    entries.sort(function(a, b) {
      return b.count - a.count;
    });

    var total = entries.reduce(function(sum, e) {
      return sum + e.count;
    }, 0);

    var selected = entries.slice(0, topN);
    if (entries.length > topN) {
      var othersCount = entries.slice(topN).reduce(function(sum, e) {
        return sum + e.count;
      }, 0);
      selected.push({ name: "其他树种", count: othersCount });
    }

    // 计算百分比
    selected.forEach(function(e) {
      e.percent = total > 0 ? (e.count / total * 100) : 0;
    });

    // 从小到大排序，方便画横向条形图
    selected.sort(function(a, b) {
      return a.percent - b.percent;
    });

    return {
      total: total,
      data: selected
    };
  }

  var stats = buildSpeciesStats(
    (typeof XA_GUSHU !== "undefined" ? XA_GUSHU : []),
    10 // 前 10
  );

  console.log("树种组成统计：", stats);

  // 5. 用 Chart.js 画横向条形图
  var ctx = document.getElementById('speciesChart').getContext('2d');

  var labels = stats.data.map(function(e) { return e.name; });
  var percents = stats.data.map(function(e) { return Number(e.percent.toFixed(1)); });

  // Morandi 配色
  var palette = [
    "#C26161",  // 暖红
    "#E6E6D9",  // 米白
    "#5C3D4C",  // 深紫红
    "#79C26D",  // 浅绿
    "#CCA6BF",  // 粉紫
    "#D9CC66",  // 土黄
    "#CE6D9D",  // 玫粉
    "#5CAC45",  // 深绿
  ];
  var colors = [];
  for (var i = 0; i < labels.length; i++) {
    colors.push(palette[i % palette.length]);
  }

  var speciesChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '占比 (%)',
        data: percents,
        backgroundColor: colors,
        borderWidth: 0
      }]
    },
    options: {
      indexAxis: 'y', // 横向条形图
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var idx = context.dataIndex;
              var e = stats.data[idx];
              return e.name + "："
                     + e.count + " 株，"
                     + e.percent.toFixed(1) + "%";
            }
          }
        },
        title: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: {
            display: true,
            text: "占比（%）"
          },
          grid: {
            drawBorder: false,
            color: "rgba(0,0,0,0.08)",
            borderDash: [4, 4]
          }
        },
        y: {
          ticks: {
            autoSkip: false,
            font: {
              size: 11
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
</script>
</body>
</html>

